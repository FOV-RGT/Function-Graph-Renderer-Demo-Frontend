<template>
    <div
        class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 w-1/2 h-1/2 select-none pointer-events-none">
        <div class="relative w-full">
            <svg id="_设置组件" data-name="设置组件" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1113.61 652.2"
                class="main w-full">
                <g id="_主体" data-name="主体" class="pointer-events-auto">
                    <polygon class="cls-2" points="290.15 139.54 285.57 153.26 496.91 296.96 290.15 139.54" />
                    <polygon class="cls-2"
                        points="972.33 349.64 737.38 367.84 733.15 375.24 999.47 379.33 1039.74 290.55 988.19 293.99 972.33 349.64" />
                    <polygon class="cls-2" points="126.86 334.94 129.82 357.84 288.07 363.71 126.86 334.94" />
                    <path class="cls-2"
                        d="m878.26,66.84c-36.38,10.48-72.77,20.96-109.15,31.44-2.49,5.8-4.98,11.6-7.47,17.39l97.09-28.72c6.51-6.7,13.02-13.4,19.53-20.11Z" />
                    <polygon class="cls-2" points="892.05 81.21 900.67 64.55 886.45 66.84 878.26 85.23 892.05 81.21" />
                    <polygon class="cls-2"
                        points="624.47 413.21 611.81 412.95 637.01 423.55 651.23 445.48 679.17 448.71 671.19 432.41 657.79 426.88 624.47 413.21" />
                    <polygon class="cls-2" points="559.18 412.01 566.56 416.16 563.86 409.58 559.18 412.01" />
                    <polygon class="cls-2"
                        points="643.72 325.89 619.6 332.73 631.05 331.43 700.4 321.99 698.87 312.78 730.26 305.31 766.54 285.05 664.08 320.12 643.72 325.89" />
                    <polygon class="cls-2"
                        points="991.32 159.52 976.93 108.77 1113.61 22.13 1109.06 0 915.9 127.66 945.65 185.02 991.32 159.52" />
                    <polygon class="cls-2"
                        points="534.24 414.74 533.51 412.93 532.16 409.21 520.62 414.49 519.4 415.04 519.38 415.05 453.62 445.16 394.61 472.18 394.58 472.2 193.5 605.09 425.63 475.45 262.3 652.2 497.3 435.42 544.84 408.87 544.84 408.87 534.24 414.74" />
                    <polygon class="cls-2"
                        points="862.79 98.28 735.94 139.64 543.92 347.44 733.25 217.77 862.79 98.28" />
                    <polygon class="cls-2" points="343.59 217.71 324.74 250.23 501.36 330.21 343.59 217.71" />
                    <path class="cls-1"
                        d="m988.19,293.99l15.29-53.66-273.2,64.98h-.02s-31.39,7.47-31.39,7.47l1.53,9.21-69.35,9.44-11.45,1.3,24.12-6.84,20.36-5.77,102.46-35.07,196.16-67.14-17.05-32.89-29.74-57.37-13.38-25.81-169.27,115.93-189.33,129.67-1.8,1.23-40.76-18.46-176.62-79.98-126.63-57.35-.88,123.18,248.13,50.38,2.55-3.6,4.32-6.1,27.27,8.21,22.18,6.69-34.45-1.28-3.11-.12-5.94-.22-14.87-.55-155.24-5.76-158.25-5.87-29.48-1.09,53.06,92.45,55.93,15.01,54.82-27.06,58.72.04,173.77-41.35.08-.02-20.31,10.52,1.49-3.6-270.58,77.23h-.03s-.01,0-.01,0l-173.58,49.54h0s-33.7,9.62-33.7,9.62l92.28,71.46,53.26-24.39c9.15-12.03,11.11-15.2,11.51-15.06.43.14,63.05-20.65,91.85-27.06l145.69-71.88h.03s59.01-27.03,59.01-27.03l65.76-30.11h.02s1.22-.56,1.22-.56l11.54-5.28,1.35,3.72.73,1.81,10.6-5.87h0l7.55,6.68,6.8-3.54,4.68-2.43,2.7,6.58,8.96,21.82,9.39,9.38,85.34,83.43,318.04,40.62-284.8-119.86-24.31-2.82-27.93-3.24-14.23-21.92-25.19-10.6,12.65.26,33.33,13.67,13.39,5.53,47.6,19.67,221.9,9.66,44.43-60.39-370.71-23.99h0s122.95-9.52,122.95-9.52l234.95-18.2,15.86-55.65Z" />
                    <polygon class="cls-2"
                        points="207.28 479.97 207.29 479.97 207.32 479.96 26.04 516.94 33.7 529.51 33.7 529.51 207.28 479.97" />
                </g>
                <g id="_爱心装饰" data-name="爱心装饰" class="pointer-events-auto">
                    <path class="cls-2"
                        d="m568.35,291.26c-1.33-2.13-18.05-27.91-49.71-28.8-30.69-.87-48.59,22.41-50.28,24.68-1.66,3.95-9.83,24.53-.52,47.33,11.73,28.74,40.86,35.59,43.54,36.17,17.13,3.71,29.01,9.97,53.46,14.51,17.08,3.17,31.48,4.85,41.75,5.8-1.24-3.31-2.6-8.44-1.4-14.11,2.95-13.92,18.17-16.24,32.74-29.68,2.3-2.12,24.36-22.6,23.66-50.35-.56-22.25-13.22-36.86-16.69-40.62-3.86-2.15-19.72-10.37-38.82-5.17-18.34,5-32.69,20.48-37.74,40.25Z" />
                    <g>
                        <path class="cls-3"
                            d="m570.33,305.71c-6.22-17.53-20.82-29.42-37.31-30.4-16-.95-31.19,8.53-39.2,24.44-2.15,8.6-3.59,21.1,1.17,33.24,6.43,16.41,20.68,23.25,32.6,28.97,8.22,3.95,16.04,5.72,31.35,9.1,14.65,3.24,26.9,5.25,35.51,6.5,1.37-3.42,3.69-8.51,7.37-13.96,7.42-11.01,13.38-13.12,20.53-20.45,2.76-2.83,19.37-19.86,17.72-40.34-1.09-13.5-9.69-23.04-14.71-27.63-3.08-2.21-12.94-8.65-25.13-6.18-14.63,2.96-26.63,17.54-29.89,36.7Z" />
                        <path class="cls-1"
                            d="m570.36,306.07c-.55-.61-1.47-2.09-1.93-2.95-3.59-5.97-8.43-11.45-14.08-15.38-15.66-11.3-36.28-8.43-48.11,6.51-2.24,2.7-4.11,5.72-5.61,8.93l.59-1.58c-2.45,10.73-2.07,21.75,2.17,30.76,4.41,9.69,13.68,16.06,22.96,21.07,2.23,1.22,5.46,2.99,7.7,4.04,7.59,3.62,17.09,6.08,25.19,8.71,11.66,3.72,23.4,7.2,35.25,11.02l-.39.23c3.85-9.46,9.39-18.45,17.2-25.15,3.87-3.32,7.96-6.34,11.45-10.07,10.24-10.84,18.6-25.43,16.79-40.8-1.21-10.12-7.01-19.17-14.44-25.95-4.96-3.55-11.25-6.2-17.53-6.58-16.55-1.18-29.67,12.95-34.52,27.66-1.22,3.07-1.58,6.47-2.69,9.54h0Zm-.06-.73c-.05-.78-.08-1.35.13-2.07,1.16-5.52,3.12-10.87,5.9-15.78,10.52-18.81,31.06-25.73,49.23-12.6,22.78,20.77,17.38,47.14-2.29,67.82-3.49,3.74-7.64,6.81-11.5,10.12-3.86,3.3-7.16,7.18-9.96,11.41-2.8,4.23-5.15,8.75-7.04,13.46l-.05.22h-.35c-15.59.39-31.06-1.26-46.45-3.61-7.95-1.26-16.14-2.9-23.62-6.22-14.37-5.8-28.46-14.19-35.3-28.86-6.44-13.23-6.25-28.61-2.36-42.3,2.33-4.45,5.21-8.63,8.65-12.34,21.28-22.99,56.76-19.13,71.16,8.83,1.61,3.14,2.82,6.42,3.69,9.82,0,0,.1.39.1.39.19.58-.09.9.04,1.71h0Z" />
                    </g>
                    <path class="cls-5"
                        d="m576.67,319.93c-15.73-.62-28.13,1.45-36.32,3.38-9.89,2.33-26.84,6.32-28.09,14.87-.22,1.5.09,2.79.38,3.64,1.77,1.46,4.47,3.57,7.95,5.82,6.02,3.91,11.26,6.27,14.71,7.71,12,4.99,20.84,6.77,39.54,12.03,3.93,1.11,10.06,2.86,17.62,5.17,4.52-8.33,9.31-14.01,12.73-17.59,7.35-7.66,10.37-8.82,19.22-17.67,0,0,4.91-5.58,9.9-15.45,1.35-2.68,3.19-6.7,2.48-11.49-.22-1.47-.35-2.19-.63-2.54-6.24-7.9-55.8,22.5-62.56,20.6-.77-.22-2.88-.87-3.19-2.27-.52-2.41,4.68-5.37,6.25-6.22Z" />
                    <path class="cls-4"
                        d="m571.69,322.29c-14.09-.05-25.17,2.15-32.55,4.12-14.55,3.88-18.39,7.88-20.11,11.59-1.51,3.25-1.48,6.48-1.24,8.64,2.1,1.4,5.05,3.26,8.71,5.25,6.2,3.36,11.85,5.67,17.81,7.76,12.97,4.54,17.38,4.6,31.98,9,7.19,2.17,12.95,4.21,16.56,5.55,3.5-6.87,7.23-11.82,10.05-15.13,6.79-7.94,9.96-9.13,20.55-19.72,0,0,4.92-5.29,10.02-14.36,1.65-2.93,3.71-6.73,2.74-10.98-.24-1.05-.53-2.33-1.34-3.19-5.4-5.77-31.53,9.48-33.71,10.77-15.74,9.3-21.76,16.61-29.09,14.13-.52-.18-5.42-1.91-5.94-5.55-.39-2.76,1.83-5.88,5.55-7.85Z" />
                    <path class="cls-3"
                        d="m612.67,346.51c.69,3.01-14.15,9.4-26.62,12.54-14.75,3.72-32.48,4.51-33.22,1.34-.73-3.09,14.64-9.91,28.24-13.12,14.08-3.31,30.9-3.84,31.6-.77Z" />
                </g>
            </svg>
            <div
                class="group absolute top-1/2 left-1/2 w-full h-full transform -translate-x-1/2 -translate-y-1/2 overflow-visible whitespace-nowrap">
                <div class="absolute flex flex-col items-center justify-center h-1/10 w-1/11">
                    <h1 class="text-2xl text-white">移动步长</h1>
                    <input type="number" v-model.number="userConfig.moveFactor" min="0.01" max="1.00" step="0.01"
                        class="text-center text-black outline-none border-2 border-[#C8C8C8] rounded-md bg-[#C8C8C8] w-9/10"
                        @change="updateMoveFactor" @keyup.enter="updateMoveFactor" />
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/10 w-1/11">
                    <h1 class="text-2xl text-white">缩放步长</h1>
                    <input type="number" v-model.number="userConfig.zoomFactor" min="0.01" max="1.00" step="0.01"
                        class="text-center text-black outline-none border-2 border-[#C8C8C8] rounded-md bg-[#C8C8C8] w-9/10"
                        @change="updateZoomFactor" @keyup.enter="updateZoomFactor" />
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/11 w-1/11">
                    <h1 class="text-2xl text-white">辅助网格</h1>
                    <input type="checkbox" checked="checked"
                        class="toggle checked:bg-neutral-700 checked:text-[#AEA181] checked:border-[#978c70]"
                        v-model="userConfig.grid" @change="updateUserConfig" />
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/11 w-1/8">
                    <h1 class="text-2xl text-white">全局采样点数</h1>
                    <input type="number" :value="userConfig.globalSamples" min="500" max="5000" step="1"
                        placeholder="50-5000"
                        class="text-center text-black outline-none border-2 border-[#C8C8C8] rounded-md bg-[#C8C8C8] w-9/10"
                        @change="updateAllSamples($event.target.value, $event)"
                        @keyup.enter="updateAllSamples($event.target.value, $event)" />
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/11 w-1/11">
                    <h1 class="text-2xl text-white">辅助虚线</h1>
                    <input type="checkbox" checked="checked"
                        class="toggle checked:bg-neutral-700 checked:text-[#AEA181] checked:border-[#978c70]"
                        v-model="userConfig.dash" @change="updateUserConfig" />
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/10 w-1/8">
                    <h1 class="text-2xl text-white">全局渲染范围</h1>
                    <div
                        class="flex flex-row items-center justify-center gap-1 border-2 border-[#C8C8C8] rounded-md bg-[#C8C8C8] w-9/10">
                        <input type="number" class="text-center text-black outline-none w-1/3" v-model.number="minVal"
                            @change="setRenderRange" @keyup.enter="setRenderRange" />
                        <p class="flex text-center justify-center items-center text-xl text-black" v-text="'<x<'"></p>
                        <input type="number" class="text-center text-black outline-none w-1/3" v-model.number="maxVal"
                            @change="setRenderRange" @keyup.enter="setRenderRange" />
                    </div>
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/13 w-1/10">
                    <h1 class="text-2xl text-white">坐标轴类型</h1>
                    <select class="select text-black bg-[#C8C8C8] focus:outline-none focus:border-[#C8C8C8] w-9/10"
                        v-model="userConfig.chartType" @change="updateUserConfig">
                        <option value="linear" class="text-black bg-white">线性</option>
                        <option value="log" class="text-black bg-white">对数</option>
                    </select>
                </div>
                <div class="absolute flex flex-col items-center justify-center h-1/10 w-1/6">
                    <h1 class="text-2xl text-white">锁定摄像机聚焦点</h1>
                    <input type="checkbox" checked="checked"
                        class="toggle checked:bg-neutral-700 checked:text-[#AEA181] checked:border-[#978c70]"
                        v-model="userConfig.lockCameraFocus" @change="updateUserConfig" />
                </div>
            </div>
        </div>
    </div>
</template>

<script>
import icon from './icon.vue'
import { clamp, deepClone } from '../assets/utils/componentUtils.js'
import { uploadUserConfig } from '../services/userService.js'
import { mapGetters } from 'vuex'


export default {
    components: {
        icon
    },
    data() {
        return {
            userConfig: {
                chartType: 'linear',
                range: null,
                dash: false,
                grid: true,
                zoomFactor: 0.5,
                moveFactor: 0.2,
                globalSamples: 2025,
                lockCameraFocus: false,
            },
            minVal: '',
            maxVal: '',
        }
    },

    computed: {
        ...mapGetters('auth', ['remoteConfig', 'isAuthenticated']),
    },

    mounted() {
        this.userConfig = deepClone(this.remoteConfig);
        this.minVal = this.userConfig.range ? this.userConfig.range[0] : '';
        this.maxVal = this.userConfig.range ? this.userConfig.range[1] : '';
    },

    methods: {
        selfClose() {
            this.$emit('close');
        },
        setRenderRange() {
            const validMin = typeof this.minVal === 'number' && !Number.isNaN(this.minVal);
            const validMax = typeof this.maxVal === 'number' && !Number.isNaN(this.maxVal);
            if (validMin && validMax) {
                if (this.minVal > this.maxVal) {
                    this.minVal = this.maxVal;
                }
                if (this.maxVal < this.minVal) {
                    this.maxVal = this.minVal;
                }
            }
            this.minVal != this.maxVal && validMin && validMax ? this.userConfig.range = [this.minVal, this.maxVal] : this.userConfig.range = null;
            this.updateUserConfig();
        },

        updateZoomFactor() {
            this.userConfig.zoomFactor = clamp(this.userConfig.zoomFactor, 0.01, 1.00);
            this.updateUserConfig();
        },

        updateMoveFactor() {
            this.userConfig.moveFactor = clamp(this.userConfig.moveFactor, 0.01, 1.00);
            this.updateUserConfig();
        },

        updateAllSamples(value, evt) {
            const validSamples = clamp(value, 500, 5000);
            const isValidNumber = /^\d+$/.test(value);
            if (isValidNumber) {
                this.userConfig.globalSamples = validSamples;
                this.updateUserConfig();
            }
            evt.target.value = validSamples;
        },

        async updateUserConfig() {
            this.$store.commit('auth/updateUserConfig', this.userConfig);
            if (!this.isAuthenticated) return;
            const { success, error } = await uploadUserConfig(this.userConfig);
            if (success) {
                // console.log('设置已保存');
            } else {
                console.log(error);
            }
        }
    }
}
</script>

<style scoped>
@import url('../assets/componentCss/adjustWindow.css')
</style>
